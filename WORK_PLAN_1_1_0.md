# 작업 계획: v1.1.0 - 비동기 미디어 생성 실시간 UI 업데이트

**이슈**: #104
**버전**: v1.1.0
**목표**: 비동기 생성이 완료되면 해당 생성기 페이지에서 바로 결과물 조회 가능

---

## 📋 요구사항 요약

비동기로 생성되는 미디어(오디오, 이미지, 트윗)가 완료되었을 때:
- ❌ **현재**: 라이브러리 페이지로만 반영 (생성기 페이지는 미반영)
- ✅ **변경**: 생성기 페이지에서도 실시간으로 결과 표시

---

## 🎯 영향 범위 분석

### 주요 생성기 페이지
```
app/apps/
├── audio-generator/page.tsx        # 오디오 생성기
├── audio-generator/create/page.tsx # 생성 페이지
├── art-generator/page.tsx          # 아트 생성기
├── tweet-generator/page.tsx        # 트윗 생성기
└── tweet-generator/create/page.tsx # 생성 페이지
```

### 관련 스토어 (lib/stores/)
- 오디오 스토어
- 아트 스토어
- 트윗 스토어
- 작업 큐 스토어

### 관련 API Routes
```
app/api/
├── audio/generate
├── art/generate
└── tweet/generate
```

---

## 🔍 기술적 분석

### 현재 아키텍처의 문제점

1. **상태 분리**
   - 작업 큐 상태: Zustand 스토어
   - 결과 저장: IndexedDB (라이브러리 전용)
   - 페이지 상태: 별도 컴포넌트 상태
   - **문제**: 페이지 상태와 작업 완료 간 동기화 부재

2. **생성 완료 감지**
   - 현재: 라이브러리 페이지에서만 IndexedDB 폴링
   - 문제: 생성기 페이지에서는 완료 감지 불가

3. **UI 업데이트**
   - 생성 중: 진행률 표시 ✓
   - 완료 후: 페이지 미반영 ✗

### 해결 방법

**1. 작업 완료 이벤트 시스템**
- 작업 큐 완료 시 이벤트 발생
- 각 페이지에서 리스너 등록
- 완료 후 자동으로 결과 조회

**2. 상태 동기화 전략**
```
생성 시작 → 작업 큐 추가
     ↓
백그라운드 생성 (API)
     ↓
완료 → IndexedDB 저장
     ↓
완료 이벤트 발생
     ↓
페이지/라이브러리 상태 동시 업데이트
```

**3. 구현 방식**
- 이벤트 에미터 패턴 (작업 완료 이벤트)
- 또는 Zustand 스토어 구독/리스너 활용
- 또는 React Query/SWR 폴링 최적화

---

## ✅ 작업 체크리스트

### 1️⃣ 준비 작업
- [ ] 이슈 #104 확인
- [ ] 현재 작업 큐 구조 분석 (lib/queue/)
- [ ] 스토어 구조 분석 (lib/stores/)
- [ ] 생성기 페이지 컴포넌트 분석
- [ ] 설계 문서 작성 (아키텍처)

### 2️⃣ 개발 작업

#### 2.1 이벤트 시스템 구현
- [ ] 작업 완료 이벤트 에미터 생성
  - 파일: `lib/events/mediaGenerationEvents.ts` (신규)
  - 이벤트: `onAudioGenerated`, `onImageGenerated`, `onTweetGenerated`
  - 구독 함수: `subscribeToMediaGeneration()`

#### 2.2 작업 큐 수정
- [ ] 작업 완료 시 이벤트 발생
  - 파일: `lib/queue/jobQueue.ts` (수정)
  - 완료 콜백에서 이벤트 에미팅
  - 각 생성 타입별 이벤트 발생

#### 2.3 페이지 컴포넌트 수정

**오디오 생성기**
- [ ] `app/apps/audio-generator/page.tsx` 수정
  - 작업 완료 이벤트 리스너 추가
  - 완료 후 결과 조회 및 상태 업데이트
  - 리스너 정리 (useEffect cleanup)

**아트 생성기**
- [ ] `app/apps/art-generator/page.tsx` 수정
  - 작업 완료 이벤트 리스너 추가
  - 완료 후 결과 조회 및 상태 업데이트
  - 리스너 정리

**트윗 생성기**
- [ ] `app/apps/tweet-generator/page.tsx` 수정
  - 작업 완료 이벤트 리스너 추가
  - 완료 후 결과 조회 및 상태 업데이트
  - 리스너 정리

#### 2.4 커스텀 훅 생성 (재사용성)
- [ ] `lib/hooks/useMediaGeneration.ts` (신규)
  - 이벤트 구독/해제 로직 추상화
  - 각 생성기 타입 지원
  - 자동 정리 메커니즘

#### 2.5 타입 정의 추가
- [ ] `lib/types/media.ts` (수정)
  - 작업 완료 이벤트 타입 정의
  - 결과 데이터 타입 정의

### 3️⃣ 테스트
- [ ] 단위 테스트 작성
  - [ ] 이벤트 에미터 테스트
  - [ ] 작업 큐 완료 이벤트 테스트
  - [ ] 훅 테스트
- [ ] 통합 테스트
  - [ ] 오디오 생성 → 페이지 업데이트
  - [ ] 이미지 생성 → 페이지 업데이트
  - [ ] 트윗 생성 → 페이지 업데이트
- [ ] 수동 테스트
  - [ ] 각 생성기에서 생성 시작
  - [ ] 생성 중 페이지 유지
  - [ ] 생성 완료 후 결과 즉시 표시 확인

### 4️⃣ 코드 품질
- [ ] ESLint 검사: `npm run lint`
- [ ] TypeScript 타입 체크: `npm run type-check`
- [ ] 코드 포맷팅: `npm run format`

### 5️⃣ 문서화
- [ ] 이벤트 시스템 README 작성
- [ ] 훅 사용 가이드 작성
- [ ] API 문서 업데이트 (docs/API.md)
- [ ] CHANGELOG 항목 추가

### 6️⃣ PR 및 병합
- [ ] PR 생성
- [ ] 코드 리뷰 요청
- [ ] 리뷰 피드백 반영
- [ ] main 브랜치 병합
- [ ] 브랜치 정리
- [ ] v1.1.0 릴리스 노트 작성

---

## 📁 생성/수정할 파일

### 신규 파일
```
lib/events/mediaGenerationEvents.ts    # 이벤트 시스템
lib/hooks/useMediaGeneration.ts        # 커스텀 훅
__tests__/events/mediaGenerationEvents.test.ts
__tests__/hooks/useMediaGeneration.test.ts
```

### 수정 파일
```
lib/queue/jobQueue.ts                  # 완료 이벤트 추가
lib/types/media.ts                     # 타입 정의 추가
app/apps/audio-generator/page.tsx      # 리스너 추가
app/apps/art-generator/page.tsx        # 리스너 추가
app/apps/tweet-generator/page.tsx      # 리스너 추가
docs/API.md                            # 문서 업데이트
CHANGELOG.md                           # 변경 로그 추가
```

---

## ⏱️ 예상 소요 시간

| 단계 | 작업 | 예상 시간 |
|------|------|---------|
| 1 | 준비 작업 | 1시간 |
| 2.1 | 이벤트 시스템 | 2시간 |
| 2.2 | 작업 큐 수정 | 1시간 |
| 2.3 | 페이지 컴포넌트 수정 | 3시간 |
| 2.4 | 커스텀 훅 | 1시간 |
| 2.5 | 타입 정의 | 0.5시간 |
| 3 | 테스트 | 3시간 |
| 4 | 코드 품질 | 0.5시간 |
| 5 | 문서화 | 1시간 |
| 6 | PR & 병합 | 1시간 |
| **총 예상** | | **14시간** |

---

## 🎯 수용 기준 (Acceptance Criteria)

- [x] 오디오 생성 완료 → 오디오 생성기 페이지에 즉시 표시
- [x] 이미지 생성 완료 → 아트 생성기 페이지에 즉시 표시
- [x] 트윗 생성 완료 → 트윗 생성기 페이지에 즉시 표시
- [x] 페이지 새로고침 없이 결과물 표시
- [x] 여러 생성 동시 진행 시 모두 반영
- [x] 모든 생성기에서 일관된 동작
- [x] 테스트 커버리지 80% 이상

---

## 📌 주의사항

1. **메모리 누수 방지**
   - 이벤트 리스너는 반드시 정리 필요
   - useEffect cleanup에서 구독 해제

2. **중복 제거**
   - 동일한 결과가 여러 번 표시되지 않도록 확인
   - 타임스탠프/ID 기반 중복 체크

3. **성능 최적화**
   - 너무 빈번한 렌더링 방지
   - 배치 업데이트 고려

4. **에러 처리**
   - 생성 실패 시 에러 상태 전파
   - 타임아웃 처리

---

## 🔄 다음 단계

1. ✅ **이슈 생성** - #104 (완료)
2. ⏭️ **브랜치 생성** - `feature/104-async-media-ui-update`
3. ⏭️ **개발 시작** - 이벤트 시스템부터 구현
4. ⏭️ **테스트** - 각 단계별 테스트
5. ⏭️ **PR 생성** - GitHub에 PR 제출
6. ⏭️ **병합** - 코드 리뷰 후 병합

---

**작성일**: 2025-10-19
**버전**: v1.1.0
**상태**: 계획 수립 완료
